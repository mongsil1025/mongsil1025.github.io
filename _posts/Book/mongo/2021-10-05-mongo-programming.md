---
title:  "[MongoDB in Action] MongoDBë¥¼ ì´ìš©í•œ í”„ë¡œê·¸ëž˜ë°"
date: 2021-10-05
excerpt: ""
tags: [book, mongoDB-in-action]
classes: narrow
toc: true
toc_sticky: true
categories: [book/mongoDB-in-action]
---

ì´ ë‚´ìš©ì€ **ëª½ê³ ë””ë¹„ ì¸ ì•¡ì…˜ 2nd Edition** ì±…ì„ ì½ê³  ê°œì¸ì ìœ¼ë¡œ ì •ë¦¬í•œ ë‚´ìš©ìž…ë‹ˆë‹¤.
{: .notice-info}

3ìž¥ì—ì„œëŠ” ë£¨ë¹„ ë“œë¼ì´ë²„ë¥¼ í†µí•œ CRUDë¥¼ ì•Œì•„ë³¸ë‹¤. ì´ëŸ¬í•œ ë“œë¼ì´ë²„ê°€ ì–´ë–»ê²Œ MongoDBì™€ ì—°ê²°ë˜ëŠ”ì§€ ì„¤ëª…í•œë‹¤. ê·¸ë¦¬ê³  ê°„ë‹¨í•œ ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ìž‘ì„±í•´ë³¸ë‹¤.

## ë£¨ë¹„ë¥¼ í†µí•´ ë³´ëŠ” ëª½ê³ DB

ë£¨ë¹„ê°€ ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ìžˆì–´ì•¼ í•œë‹¤.

```
gem install mongo
```

ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ë£¨ë¹„ ë“œë¼ì´ë²„ë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìžˆë‹¤.

ëª½ê³  ë“œë¼ì´ë²„ë¥¼ load í•˜ê³ , ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìž‘ì„±í•˜ë©´, ìŠ¤í¬ë¦½íŠ¸ë¡œ ê°„íŽ¸í•˜ê²Œ ëª½ê³ DBë¥¼ ì—°ê²°í•  ìˆ˜ ìžˆë‹¤.

ì‹¤í–‰ì€ `ruby connect.rb` ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•  ìˆ˜ ìžˆë‹¤.

### ë£¨ë¹„ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…

ìžë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ JSONì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ ì²˜ëŸ¼ ë£¨ë¹„ì—ì„œëŠ” í•´ì‹œ ë°ì´í„°ë¥¼ ì‚¬ìš©í•œë‹¤. JSONì€ ":" ìœ¼ë¡œ key-value ë¥¼ êµ¬ë¶„í•˜ì§€ë§Œ ë£¨ë¹„ëŠ” ë¡œì¼“ (=>) ìœ¼ë¡œ êµ¬ë¶„í•œë‹¤.

ë£¨ë¹„ ëŒ€í™”í˜• ì…¸ì€ `irb` ì´ë‹¤. `irb`ëŠ” REPL(Read, Evaluable, Print, Loop) ì½˜ì†”ë¡œ, ë™ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ë£¨ë¹„ ì½”ë“œë¥¼ ìž‘ì„±í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ê¸°ì— ìµœì ì˜ ìƒíƒœë¡œ ë§Œë“¤ ìˆ˜ ìžˆê²Œ í•´ì¤€ë‹¤.

ì•„ê¹Œ ì‹¤í–‰í–ˆë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ `irb -r` ë¡œ ìˆ˜í–‰í•˜ë©´, ì»¤ë„¥ì…˜, ë°ì´í„°ë² ì´ìŠ¤, ì»¬ë ‰ì…˜ ê°ì²´ì— ì§ì ‘ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìžˆë‹¤.

### ì‚½ìž…

ì•„ëž˜ì™€ ê°™ì´ ëª½ê³ DBì— ë°ì´í„°ë¥¼ ì‚½ìž…í•  ìˆ˜ ìžˆë‹¤.
![í™”ë©´ ìº¡ì²˜ 2021-10-05 010610](/assets/í™”ë©´%20ìº¡ì²˜%202021-10-05%20010610.png)

ë£¨ë¹„ ì‰˜ì„ ì´ìš©í•´ì„œ, ìžìœ ë¡­ê²Œ ì „ì—­ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ê³  mongo ì‰˜ì˜ ëª…ë ¹ì–´ë¥¼ ì“¸ ìˆ˜ ìžˆë‹¤. (ì˜¤íƒ€ê°€ ë‚˜ì§€ ì•Šê²Œ ì¡°ì‹¬í•˜ìž ðŸ˜‚)
```
irb(main):006:0> sunmin = {"last_name" => "jeong", "age" => 28}
=> {"last_name"=>"jeong", "age"=>28}
irb(main):010:0> puts sunmin
{"last_name"=>"jeong", "age"=>28}
=> nil
irb(main):011:0> sunmin_id = $users.insert_one(sunmin)
```

ë£¨ë¹„ì˜ `p` ë©”ì„œë“œë¥¼ ì•žì— ë¶™ì—¬ì„œ ìŠ¤í¬ë¦°ì— í”„ë¦°íŠ¸í•  ìˆ˜ ìžˆë‹¤.

```
p $users.find( :age => {"$gt" => 20}).to_a
```

### ì¿¼ë¦¬ì™€ ì»¤ì„œ

ìœ„ì—ì„œ age > 20 ì¸ ìœ ì €ë¥¼ 2ê°œ ì¶”ê°€í–ˆë‹¤. "age > 20" ì¡°ê±´ì¸ ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ë³´ë©´, Mongo::Collection::View ê°ì²´ì— ê²°ê³¼ê°’ì´ ë°˜í™˜ëœë‹¤. ì´ê²Œ ì»¤ì„œì´ë‹¤.

```
irb(main):025:0> $users.find({"age" => {"gt" => 20}})
=> #<Mongo::Collection::View:0x54170960 namespace='tutorial.users' @filter={"age"=>{"gt"=>20}} @options={}>
```

ë£¨ë¹„ì—ì„œëŠ” ìœ„ì™€ ê°™ì€ ì»¤ì„œë¥¼ í†µí•´ `each` ë¬¸ìœ¼ë¡œ ë£¨í•‘ì„ í•˜ë©° ë°ì´í„°ë¥¼ ì¶œë ¥í•  ìˆ˜ ìžˆë‹¤. MongoDB ì…¸ ë˜í•œ ì´ì™€ ê°™ì€ ë°©ë²•ìœ¼ë¡œ `find()`ë¥¼ ì‹¤í–‰í•˜ëŠ”ë°, ìžë™ìœ¼ë¡œ ì»¤ì„œë¥¼ 20íšŒ ë°˜ë³µí•˜ì—¬ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ì ì´ ë‹¤ë¥´ë‹¤.


### ì—…ë°ì´íŠ¸ì™€ ì‚­ì œ

```
irb(main):032:0> $users.find({"last_name" => "jeong"}).update_one({"$set" => {"home" => "SweetHome"}})
=> #<Mongo::Operation::Update::Result:0x55110020 documents=[{"n"=>1, "nModified"=>1, "ok"=>1.0}]>
```

- `update_one` : ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” ë‹¤íë¨¼íŠ¸ í•œê°œë§Œ ì—…ë°ì´íŠ¸í•œë‹¤.
- `update_many` : ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ë„íë¨¼íŠ¸ë¥¼ ì—…ë°ì´íŠ¸ í•œë‹¤.
- `delete_one` : íŒŒë¼ë¯¸í„° ì—†ì´ ìˆ˜í–‰í•˜ë©°, 1ê°œì˜ ë„íë¨¼íŠ¸ë¥¼ ì‚­ì œí•œë‹¤.
- `delete_many` : ì¡°ê±´ì— ë§žëŠ” ëª¨ë“  ë„íë¨¼íŠ¸ë¥¼ ì‚­ì œí•œë‹¤.
- `drop` : ëª¨ë“  ë„íë¨¼íŠ¸ë¥¼ ì‚­ì œí•œë‹¤.

### ë°ì´í„°ë² ì´ìŠ¤ ëª…ë ¹ì–´

`listDatabases` ëª…ë ¹ì–´ë¥¼ í†µí•´ ë“œë¼ì´ë²„ì—ì„œ ì–´ë–»ê²Œ ë°ì´í„°ë² ì´ìŠ¤ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìžˆëŠ”ì§€ ì‚´íŽ´ë³´ê² ë‹¤. ì´ ëª…ë ¹ì–´ëŠ” admin ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€í•´ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ëª…ë ¹ì–´ ê°€ìš´ë° í•˜ë‚˜ì´ë‹¤. admin ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì¸ì¦ì´ ì‚¬ìš©ë  ë•Œ íŠ¹ë³„í•˜ê²Œ ì·¨ê¸‰ëœë‹¤. (10ìž¥ì—ì„œ ìžì„¸ížˆ ë‹¤ë£¬ë‹¤.)

```
irb(main):034:0> $admin_db.command({"listDatabases" => 1})
=> #<Mongo::Operation::Result:0x55079920 documents=[{"databases"=>[{"name"=>"admin", "sizeOnDisk"=>69632.0, "empty"=>false}, {"name"=>"config", "sizeOnDisk"=>110592.0, "empty"=>false}, {"name"=>"local", "sizeOnDisk"=>86016.0, "empty"=>false}, {"name"=>"tutorial", "sizeOnDisk"=>73728.0, "empty"=>false}], "totalSize"=>339968.0, "ok"=>1.0}]>
```

`listDatabases` : í˜„ìž¬ ì¡´ìž¬í•˜ëŠ” ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ì™€ ë””ìŠ¤í¬ìƒì˜ ìš©ëŸ‰ì— ëŒ€í•œ ì •ë³´ë¥¼ ë£¨ë¹„ì˜ í•´ì‹œë¡œ ë³´ì—¬ì¤€ë‹¤.

## ë“œë¼ì´ë²„ ìž‘ë™ ì›ë¦¬

MongoDB ë“œë¼ì´ë²„ëŠ” ì„¸ ê°€ì§€ ì£¼ìš”í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•œë‹¤.
- ëª¨ë“  ë„íë¨¼íŠ¸ì˜ `_id` í•„ë“œì— ë””í´íŠ¸ë¡œ ì €ìž¥ë˜ëŠ” ê°’ì¸ ê°ì²´ IDë¥¼ ìƒì„±í•œë‹¤.
- íŠ¹ì • ì–¸ì–´ë¡œ í‘œí˜„ëœ ë„íë¨¼íŠ¸ì™€ MongoDBì˜ ì´ì§„ ë°ì´í„° í¬ë§·ì¸ BSON ì‚¬ì´ì˜ ë³€í™˜ì„ ìˆ˜í–‰í•œë‹¤. (ì§ë ¬í™” & ì—­ì§ë ¬í™”)
- MongoDBì˜ ì™€ì´ì–´ í”„ë¡œí† ì½œì„ ì‚¬ìš©í•´ì„œ ë„¤íŠ¸ì›Œí¬ ì†Œì¼“ì„ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ì™€ í†µì‹ í•œë‹¤.


### ê°ì²´ ID ìƒì„±

ëª½ê³ DBì—ì„œ `_id` í•„ë“œëŠ” PKì´ë‹¤. ê°œë°œìžê°€ ìž„ì˜ì˜ ê°’ì„ ë„£ì–´ì£¼ëŠ”ê²ƒì´ ê°€ëŠ¥í•˜ì§€ë§Œ, ì£¼ì–´ì§€ì§€ ì•Šì„ ê²½ìš°ì—ëŠ” MongoDB ê°ì²´ IDê°€ ì‚¬ìš©ëœë‹¤.

```
615b22e5/22c7e25178/ae6807
```

ëª½ê³ DB ObjectID ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê·œì•½ì„ ë”°ë¥¸ë‹¤. [Object Id](https://docs.mongodb.com/manual/reference/method/ObjectId/)

- 4-byte timestamp value, representing the ObjectId's creation, measured in seconds since the Unix epoch
- 5-byte random value
- 3-byte incrementing counter, initialized to a random value

ë„íë¨¼íŠ¸ì—ì„œëŠ” 5byteê°€ ëžœë¤ê°’ì´ë¼ê³  ëª…ì‹œë˜ì–´ ìžˆì§€ë§Œ, ì±…ì—ì„œëŠ” 3byte ëŠ” ì„œë²„ì˜ id, ë‚˜ë¨¸ì§€ 2byteëŠ” í”„ë¡œì„¸ìŠ¤ì˜ idë¼ê³  ì–˜ê¸°í•œë‹¤.

PK ì¤‘ë³µì´ ì´ë£¨ì–´ì§€ì§€ ì•Šê²Œ í•˜ê¸° ìœ„í•´ì„œ ìœ ë‹ˆí¬í•œ ì‹ë³„ìžë¥¼ ìƒì„±í•´ì•¼ í•˜ëŠ”ë°, ê·¸ ìˆ˜ë‹¨ìœ¼ë¡œ íƒ€ìž„ìŠ¤í…œí”„, ì„œë²„ID, ê·¸ë¦¬ê³  í”„ë¡œì„¸ìŠ¤IDë¥¼ í™œìš©í•œ ê²ƒì´ë‹¤.

`_id`ì— íƒ€ìž„ìŠ¤íƒ¬í”„ ì •ë³´ê°€ ìžˆê¸° ë•Œë¬¸ì—, ë„íë¨¼íŠ¸ì˜ ìƒì„±ì‹œê°„ì„ ì•Œ ìˆ˜ ìžˆë‹¤.

```
irb(main):035:0> id = BSON::ObjectId.from_string('615b22e522c7e25178ae6807')
=> BSON::ObjectId('615b22e522c7e25178ae6807')
irb(main):036:0> id.generation_time
=> 2021-10-04 15:51:01 UTC
```

ê°ì²´ì˜ ìƒì„±ì‹œê°„ì— ëŒ€í•œ ë²”ìœ„ ì§ˆì˜ë¥¼ í•  ë•Œë„ ObjectIDë¥¼ í™œìš©í•  ìˆ˜ ìžˆë‹¤.

```
jun_id = BSON::ObjectId.from_time(Time.utc(2021, 10, 5))
```

## íŠ¸ìœ„í„° ëª¨ë‹ˆí„°ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ êµ¬ì¶•

ì±…ì— ìžˆëŠ” ì‹¤ìŠµì½”ë“œ ì˜ˆì œë¥¼ ìˆ˜í–‰í•´ë³¸ë‹¤.

ì—¬ê¸°ì„œëŠ” `gem` ì„ í†µí•´ í•„ìš”í•œ ëª¨ë“ˆì„ ë°›ì•„ì˜¨ë‹¤.

```
source 'https://rubygems.org'

gem 'mongo', '1.9.2'
gem 'bson_ext', '1.9.2'
gem 'twitter', '5.8.0'
gem 'sinatra', '1.4.4'
```

sinatra ëŠ” ê°€ë²¼ìš´ ì›¹ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ ìžˆëŠ” ë£¨ë¹„ë¡œ ê°œë°œëœ í”„ë ˆìž„ì›Œí¬ë‹¤. sinatraë¥¼ ì´ìš©í•˜ë©´, ê°„ë‹¨í•˜ê²Œ html íŽ˜ì´ì§€ë¥¼ ë§Œë“¤ ìˆ˜ ìžˆëŠ”ê²Œ ìž¥ì ì´ë‹¤.


```
get '/' do
  if params['tag']
    selector = {:tags => params['tag']}
  else
    selector = {}
  end

  @tweets = TWEETS.find(selector).sort(["id", -1])
  erb :tweets
end

```
